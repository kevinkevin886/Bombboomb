<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Python çˆ†çˆ†ç‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #222; color: white; }
        
        .screen { display: none; padding: 20px; }
        .active { display: block !important; }

        input { padding: 10px; border-radius: 5px; border: none; font-size: 16px;}
        button { margin-top: 10px; padding: 10px 20px; border-radius: 5px; cursor: pointer; background-color: #e74c3c; color: white; border: none; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #c0392b; }

        /* ç©å®¶åˆ—è¡¨æ¨£å¼ */
        #player-list { list-style: none; padding: 0; max-width: 300px; margin: 20px auto; background: #333; border-radius: 8px; }
        #player-list li { padding: 10px; border-bottom: 1px solid #444; }
        #player-list li:last-child { border-bottom: none; }

        canvas { background-color: #ecf0f1; border: 4px solid #7f8c8d; margin-top: 20px; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #winner-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9); padding: 40px; border-radius: 10px;
            text-align: center; display: none; z-index: 10;
        }
        #winner-overlay h1 { color: #f1c40f; font-size: 3em; margin: 0 0 20px 0; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ğŸ’£ çˆ†çˆ†ç‹å¤§äº‚é¬¥</h1>
        <p>æ‰€æœ‰ç©å®¶å°‡é€²å…¥åŒä¸€å€‹æˆ°å ´</p>
        <input type="text" id="username" placeholder="è«‹è¼¸å…¥ä½ çš„æš±ç¨±" />
        <br><br>
        <button onclick="joinGame()">é€²å…¥æˆ°å ´</button>
    </div>

    <div id="lobby-screen" class="screen">
        <h2>ç­‰å¾…å®¤</h2>
        <p>ç›®å‰å·²åŠ å…¥çš„ç©å®¶ï¼š</p>
        <ul id="player-list">
            </ul>
        <br>
        <button onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="info">WASD ç§»å‹• | ç©ºç™½éµ æ”¾ç½®æ ¸å½ˆ (åå­—å…¨åœ–æ”»æ“Š)</div>
        <div style="position: relative; display: inline-block;">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <div id="winner-overlay">
                <h1 id="winner-name">XXX ç²å‹!</h1>
                <button onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        
        const screens = {
            login: document.getElementById('login-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen')
        };

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        function joinGame() {
            const name = document.getElementById('username').value;
            if(!name) return alert("è«‹è¼¸å…¥æš±ç¨±");
            
            // ä¸å†éœ€è¦å‚³é€ room åƒæ•¸ï¼Œå¾Œç«¯æœƒè‡ªå‹•åˆ†é…
            socket.emit('create_join', {name: name});
            showScreen('lobby');
        }

        function startGame() {
            socket.emit('start_game', {});
        }

        // --- æ–°å¢ï¼šæ¥æ”¶å¤§å»³ç©å®¶åˆ—è¡¨æ›´æ–° ---
        socket.on('update_lobby', (data) => {
            const list = document.getElementById('player-list');
            list.innerHTML = ""; // æ¸…ç©º
            data.players.forEach(name => {
                const li = document.createElement('li');
                li.innerText = "ğŸ‘¤ " + name;
                list.appendChild(li);
            });
            
            // å¦‚æœéŠæˆ²å·²ç¶“é–‹å§‹ï¼Œç›´æ¥åˆ‡æ›éå» (çµ¦ä¸­é€”é‡æ•´çš„äººç”¨ï¼Œé›–ç„¶æœ¬ç¯„ä¾‹ä¸»è¦æ˜¯ä¸€èµ·é–‹å§‹)
            if(data.is_running) {
                showScreen('game');
            }
        });

        // æ¥æ”¶éŠæˆ²ç‹€æ…‹æ›´æ–°
        socket.on('state_update', (state) => {
            showScreen('game');
            renderGame(state);
            
            if(state.winner) {
                document.getElementById('winner-name').innerText = "ğŸ† " + state.winner + " ç²å‹!";
                document.getElementById('winner-overlay').style.display = "block";
            } else {
                document.getElementById('winner-overlay').style.display = "none";
            }
        });

        socket.on('error', (data) => alert(data.msg));

        // --- ç¹ªåœ–é‚è¼¯ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const MAP_W = 12;        // ä¿®æ”¹é»: 12x12
        const VIEW_SIZE = 600;   
        const CELL_SIZE = VIEW_SIZE / MAP_W; // 50px
        const PLAYER_SIZE = 0.7; 

        function renderGame(state) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. ç•«åœ°åœ–
            for(let y=0; y<MAP_W; y++) {
                for(let x=0; x<MAP_W; x++) {
                    if(state.map[y][x] === 1) {
                        ctx.fillStyle = "#7f8c8d";
                        ctx.fillRect(x*CELL_SIZE, y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = "#95a5a6";
                        ctx.strokeRect(x*CELL_SIZE, y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    } else {
                        ctx.strokeStyle = "#444"; 
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x*CELL_SIZE, y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }

            // 2. ç•«ç‚¸å½ˆ
            state.bombs.forEach(b => {
                const cx = b.x * CELL_SIZE + CELL_SIZE/2;
                const cy = b.y * CELL_SIZE + CELL_SIZE/2;
                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.arc(cx, cy, CELL_SIZE/2 - 4, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = "red"; // é–ƒçˆç‡ˆ
                ctx.beginPath();
                ctx.arc(cx - 5, cy - 5, 4, 0, Math.PI*2);
                ctx.fill();
            });

            // 3. ç•«çˆ†ç‚¸
            state.explosions.forEach(exp => {
                ctx.fillStyle = "rgba(231, 76, 60, 0.8)";
                ctx.fillRect(exp.x*CELL_SIZE, exp.y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
            });

            // 4. ç•«ç©å®¶
            for (const [sid, p] of Object.entries(state.players)) {
                if(!p.alive) continue;
                const px = p.x * CELL_SIZE;
                const py = p.y * CELL_SIZE;
                const pSize = PLAYER_SIZE * CELL_SIZE;

                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.roundRect(px, py, pSize, pSize, 8);
                ctx.fill();
                
                // çœ¼ç›
                ctx.fillStyle = "white";
                ctx.beginPath();
                ctx.arc(px + pSize*0.3, py + pSize*0.3, 5, 0, Math.PI*2);
                ctx.arc(px + pSize*0.7, py + pSize*0.3, 5, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.arc(px + pSize*0.3 + p.dx*3, py + pSize*0.3 + p.dy*3, 2, 0, Math.PI*2);
                ctx.arc(px + pSize*0.7 + p.dx*3, py + pSize*0.3 + p.dy*3, 2, 0, Math.PI*2);
                ctx.fill();

                ctx.fillStyle = "white";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(p.name, px + pSize/2, py - 8);
            }
        }

        const keysPressed = {};
        document.addEventListener('keydown', (e) => {
            if(!screens.game.classList.contains('active')) return;
            if(keysPressed[e.key]) return;
            keysPressed[e.key] = true;
            socket.emit('key_down', {key: e.key});
        });
        document.addEventListener('keyup', (e) => {
            if(!screens.game.classList.contains('active')) return;
            keysPressed[e.key] = false;
            socket.emit('key_up', {key: e.key});
        });
    </script>
</body>
</html>